# Fix: Monthly Report and Budget Monitoring Without Base Comparison

## Problem Identified
The `infracost-summary` and `budget-alerts` jobs were failing because they were trying to generate their own cost breakdowns, but they were running in a context where:

1. The base branch (`main`) is empty and has no infrastructure
2. The jobs were trying to run `infracost breakdown` on non-existent infrastructure directories
3. They couldn't access the cost data generated by the individual `infracost-staging` and `infracost-production` jobs

## Root Cause
- Each GitHub Actions job runs in its own isolated environment
- Files generated in `/tmp/` during one job are not accessible to other jobs
- The individual jobs (`infracost-staging`, `infracost-production`) successfully generate their cost reports
- But the summary jobs (`infracost-summary`, `budget-alerts`) were trying to regenerate the same reports independently

## Solution Implemented: Artifact Sharing

### 1. Upload Artifacts from Individual Jobs
Added artifact upload steps to both `infracost-staging` and `infracost-production`:

```yaml
- name: Upload staging cost report
  uses: actions/upload-artifact@v4
  with:
    name: staging-infracost-report
    path: /tmp/infracost.json

- name: Upload production cost report
  uses: actions/upload-artifact@v4
  with:
    name: production-infracost-report
    path: /tmp/infracost.json
```

### 2. Download Artifacts in Summary Jobs
Modified both `infracost-summary` and `budget-alerts` to download and use the pre-generated reports:

```yaml
- name: Download staging cost report
  uses: actions/download-artifact@v4
  with:
    name: staging-infracost-report
    path: /tmp/staging/

- name: Download production cost report
  uses: actions/download-artifact@v4
  with:
    name: production-infracost-report
    path: /tmp/production/
```

### 3. Updated Cost Processing Logic

#### For `infracost-summary`:
```yaml
- name: Generate combined cost report
  run: |
    # Copy files with proper names
    cp /tmp/staging/infracost.json /tmp/staging-costs.json
    cp /tmp/production/infracost.json /tmp/production-costs.json
    
    # Combine reports
    infracost output --path="/tmp/staging-costs.json,/tmp/production-costs.json" \
                    --format=slack-message \
                    --out-file=/tmp/slack-message.json
```

#### For `budget-alerts`:
```yaml
- name: Check budget thresholds
  run: |
    # Extract costs from downloaded reports
    STAGING_COST=$(cat /tmp/staging/infracost.json | jq -r '.totalMonthlyCost // "0"')
    PRODUCTION_COST=$(cat /tmp/production/infracost.json | jq -r '.totalMonthlyCost // "0"')
```

## Benefits of This Approach

1. **Reuses Existing Data**: No need to regenerate cost reports that were already created
2. **Handles Empty Base Branch**: Works regardless of whether base branch has infrastructure
3. **Consistent Data**: All jobs use the same cost calculations
4. **Efficient**: Avoids duplicate Terraform operations
5. **Resilient**: Each job uses the actual data generated by the previous jobs

## Expected Behavior

1. **`infracost-staging`** runs, generates cost report, uploads as artifact
2. **`infracost-production`** runs, generates cost report, uploads as artifact  
3. **`infracost-summary`** downloads both artifacts, combines them for Slack notification
4. **`budget-alerts`** downloads both artifacts, checks thresholds, sends alerts if needed

## Files Modified
- Added artifact upload steps to both individual cost analysis jobs
- Modified summary and budget jobs to download and process artifacts
- Added debugging output to verify file availability

## Status
âœ… Artifact sharing implemented
âœ… Both summary jobs updated to use shared data
âœ… Handles empty base branch scenario
ðŸ”„ Ready for testing with complete workflow execution
